# =============================
# 0. Kumpulan Antaramuka (Interface Groups)
# =============================
int_0="lo0 vlan0 bridge0 tap0 vm-public"        # Virtual / Loopback / VM
int_1="igb0 igb1 igb2 igb3 igb4 igb5 igb6 igb7 em0 ue0"  # Fizikal LAN
ext_if="ng0"                                    # WAN (PPPoE Unifi)
#ext_if="tun0"
#vm_net="192.168.2.0/24"

# =============================
# 1. Tetapan Umum
# =============================
set block-policy drop              # Block terus tanpa balasan (stealth)
set skip on lo0                    # Skip pemeriksaan loopback
set limit states 100000
set limit src-nodes 10000

# Don't bother to process on following interface(s).
#set skip on {$int_0, $int_1}

# =============================
# 2. Kumpulan Port (Group)
# =============================
icmp_types="{0,3,4,8,11,12}"
common_ports="{43,80,443}"
#vnc="{5800,5900,5901,5902,5909}"
rdp="33899"
torrent="33099"
# === Nintendo Switch ports ===
switch_tcp_ports = "{6667,12400,28000,28910,29500,29900,29901,29920}"
switch_udp_all = "{45000:65535}"
#switch="{6667,12400,28000,28910,29500,29900,29901,29920}"
#switchudp_0="{45000:65535}"
#switchudp_1="{52000:65535}"
urbackup_ports="{55413,55414,55415}"
nut_ports="{3551}"

# =============================
# 3. Jadual (tables)
# =============================
table <bruteforce_block> persist   # Senarai IP yang akan diblock sebab brute force
table <blacklist> persist
table <bogons> persist file "/etc/pf.bogons"   # Senarai IP bogon untuk disekat

# Port forward for ps5/ps4.
# TCP: 1935,3478-3480,
# UDP: 3074,3478-3479,
# or Both protocol: 1935,3074,3478-3480.

# =============================
# 4. Scrub (Penstabil Paket)
# =============================
scrub on $ext_if inet proto tcp max-mss 1350
scrub on $ext_if no-df

# =============================
# 5. NAT & Transparent DNS (Terjemahan Alamat & Redirect)
# =============================

# NAT keluar WAN
nat on $ext_if inet from !($ext_if) to any -> ($ext_if) static-port
#nat on $ext_if from $vm_net to any -> ($ext_if) static-port

# NAT with static port for Switch OLED Only.
#nat on $ext_if from 192.168.1.198 to any -> ($ext_if) static-port

# NAT the rest without static port.
#nat on $ext_if inet from !($ext_if) to any -> ($ext_if)

# NAT on ipv6.
#nat on $ext_if inet6 from !($ext_if) to any -> ($ext_if) static-port
#nat on $ext_if inet6 from !($ext_if) to any -> ($ext_if)

# ipv6 NAT on Maui-Ryzen
#maui_ip6="fd00:1111:2222:3333::2"
#nat on $ext_if inet6 from $maui_ip6 to any -> ($ext_if)
#nat on $ext_if inet6 from !($ext_if) to any -> ($ext_if) static-port
#nat on $ext_if inet6 proto { tcp udp icmp6 } from $maui_ip6 to any -> ($ext_if) static-port

# Nintendo Switch (gabung NAT + PASS)
rdr pass on $ext_if inet proto udp to ($ext_if) port $switch_udp_all   -> 192.168.1.198
rdr pass on $ext_if inet proto tcp to ($ext_if) port $switch_tcp_ports -> 192.168.1.198

# VNC forwarding.
#rdr on $ext_if inet proto tcp from any to any port $vnc -> 192.168.1.252
#rdr on $ext_if inet proto tcp from any to any port $vnc -> 192.168.1.189 port 9990
#rdr pass on $ext_if inet proto tcp to ($ext_if) port $rdp -> 192.168.1.189 port 3389

# Squid port 80 redirect (transparent proxy).
#rdr on $int_1 inet proto tcp from any to any port www -> 127.0.0.1 port 44445
#rdr on $int_0 inet proto tcp from any to any port www -> 127.0.0.1 port 44445
# Squid port 443 redirect (transparent proxy).
#rdr on $int_1 inet proto tcp from any to any port 443 -> 127.0.0.1 port 44446
#rdr on $int_0 inet proto tcp from any to any port 443 -> 127.0.0.1 port 44446

# =============================
# 6. Transparent DNS Rules (Filtering)
# =============================

# Transparent DNS: pengecualian untuk VM bhyve
no rdr on {$int_0, $int_1} proto {udp, tcp} from 192.168.2.152 to any port 53

# Redirect semua DNS ke AdGuard Home
rdr on {$int_0, $int_1} proto {udp, tcp} from any to any port 53 -> 192.168.1.254 port 53

# =============================
# 7. Anchor Tambahan
# =============================
rdr-anchor "miniupnpd"
anchor "miniupnpd"

# =============================
# 8. Peraturan Firewall (pass/block)
# =============================

# Block IP dari senarai bogon
block in quick on $ext_if from <bogons>

# Block IP yang disenaraihitam (automatik dari SEC)
block in quick on $ext_if from <blacklist>

# Block IP yang disenaraihitam sebab brute forcm
block in quick from <bruteforce_block>
block in quick on $ext_if from <bruteforce_block>

### - Rules lama
pass in quick proto igmp all allow-opts
pass out quick proto igmp all allow-opts

# Trafik multicast LAN
pass in quick on {$int_0, $int_1} from any to 239.0.0.0/8
pass in quick on {$int_0, $int_1} inet all keep state
pass in quick on {$int_0, $int_1} inet6 all keep state

# Trafik LAN biasa (IPv4 & IPv6)
pass in on {$int_0, $int_1} inet all keep state
pass in on {$int_0, $int_1} inet6 all keep state

# Benarkan ICMP (ping, traceroute)
pass in quick on $ext_if inet proto icmp all icmp-type $icmp_types
pass in quick on $ext_if inet6 proto icmp6 all

# SSH (port 229) – Had 10 sambungan setiap 60 saat
pass in on $ext_if proto tcp to port 229 keep state (max-src-conn-rate 10/60, overload <bruteforce_block> flush global)

# RDP (port 33899) – Had 10 sambungan setiap 60 saat
pass in on $ext_if proto tcp to port $rdp keep state (max-src-conn-rate 10/60, overload <bruteforce_block> flush global)

# Perkhidmatan WAN biasa (http/https, whois)
#pass in quick on $ext_if proto {udp, tcp} to any port $common_ports keep state
pass in quick on $ext_if proto {udp, tcp} to ($ext_if) port $common_ports keep state

# Torrent keluar masuk
pass in on $ext_if proto tcp to any port $torrent keep state
pass out on $ext_if proto tcp from any to any port $torrent keep state

# Web server (aktif atas WAN IP)
pass in quick on $ext_if proto tcp to ($ext_if) port {80,443} keep state

# Samba (LAN sahaja)
pass in on {$int_0, $int_1} proto tcp to any port {137:139,445} keep state
pass in on {$int_0, $int_1} proto udp to any port {137:139,445} keep state

# UrBackup (LAN sahaja)
pass in on {$int_0, $int_1} proto tcp to any port $urbackup_ports keep state

# NUT UPS service (LAN sahaja)
pass in on {$int_0, $int_1} proto tcp to any port $nut_ports keep state

# Port 1313 (servis tak dikenalpasti – LAN sahaja)
pass in on {$int_0, $int_1} proto tcp to any port 1313 keep state

# VoWiFi (UDP & TCP)
pass in quick on $ext_if proto udp to ($ext_if) port {500,4500,5060,5061,10000:20000} keep state
pass in quick on $ext_if proto tcp to ($ext_if) port {5060,5061} keep state

# DHCPv6 (IP versi 6)
pass in quick on $ext_if inet6 proto udp to any port dhcpv6-client keep state
pass out quick on $ext_if inet6 proto udp to any port dhcpv6-server keep state

# Trafik stateless LAN (NetBIOS, mDNS)
pass in on {$int_1} proto udp from any to any port 137 no state
pass in on {$int_1} proto udp from any to any port 138 no state
pass in on {$int_1} proto udp from any to any port 5353 no state

# =============================
# 8.1 DNS Fail-safe Blocking & DoH/DoQ Blocking
# =============================

table <dns_bypass4> persist {
  192.168.1.254
  192.168.2.152
  192.168.2.154
}

table <dns_bypass6> persist {
  fd00:1337:2337:3337::1
  fe80::5a9c:fcff:fe10:c24d
  2001:e68:541a:a9ff:5a9c:fcff:fe10:c24d
}

# Halang semua trafik DNS direct ke WAN kecuali dari AdGuard Home dan VM bhyve
block out quick on $ext_if inet proto udp from !<dns_bypass4> to port 53
block out quick on $ext_if inet proto tcp from !<dns_bypass4> to port 53 flags S/SA
block out quick on $ext_if inet6 proto udp from !<dns_bypass6> to port 53
block out quick on $ext_if inet6 proto tcp from !<dns_bypass6> to port 53 flags S/SA

# =============================
# 9. Trafik Keluar
# =============================
pass out on {$int_0, $int_1} from any to any keep state
pass out on $ext_if all keep state

# =============================
# 10. Peraturan Block Akhir
# =============================
block in on $ext_if    # Semua yang tidak dibenarkan akan diblock di sini
